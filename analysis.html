<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Why Is My Heater Using 2x The Energy?</title>
<meta property="og:title" content="Why Is My Heater Using 2x The Energy?">
<meta property="og:description" content="Deep-dive analysis of 16,896 half-hourly readings across 3 timer regimes. The current timer materially increases heater runtime and cost versus short-window schedules.">
<meta property="og:type" content="article">
<meta property="og:url" content="https://cheparukhin.github.io/octopus/analysis.html">
<meta property="og:image" content="https://cheparukhin.github.io/octopus/og-analysis.png">
<meta property="og:image:width" content="1200">
<meta property="og:image:height" content="630">
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Segoe UI',system-ui,sans-serif;background:#0a0e17;color:#c8d6e5;line-height:1.7}
.container{max-width:1100px;margin:0 auto;padding:24px 20px 60px}

/* Hero */
.hero{text-align:center;padding:48px 0 40px}
.hero h1{font-size:2.4em;color:#fff;letter-spacing:-0.02em;line-height:1.2}
.hero .lead{color:#7f8fa6;font-size:1.05em;margin:12px auto 0;max-width:640px}
.stats{display:grid;grid-template-columns:repeat(4,1fr);gap:16px;margin-top:36px}
.stat{background:#141b2d;border-radius:14px;padding:24px 16px;border:1px solid #1e2a42;text-align:center;transition:border-color .2s}
.stat:nth-child(1){border-color:#00d2ff40}
.stat:nth-child(2){border-color:#ffa50240}
.stat:nth-child(3){border-color:#ff6b6b40}
.stat:nth-child(4){border-color:#00d2ff40}
.stat .num{font-size:2.6em;font-weight:800;line-height:1;letter-spacing:-0.03em}
.stat:nth-child(1) .num{color:#00d2ff}
.stat:nth-child(2) .num{color:#ffa502}
.stat:nth-child(3) .num{color:#ff6b6b}
.stat:nth-child(4) .num{color:#00d2ff}
.stat .label{color:#7f8fa6;font-size:0.85em;margin-top:6px;line-height:1.3}

/* Sections */
section{margin-top:56px}
section h2{font-size:1.6em;color:#fff;margin-bottom:6px;letter-spacing:-0.01em}
section .section-lead{color:#7f8fa6;font-size:0.92em;margin-bottom:24px;max-width:720px}

/* Cards */
.card{background:#141b2d;border-radius:12px;padding:24px;margin-bottom:24px;border:1px solid #1e2a42}
.card h3{color:#00d2ff;font-size:1.05em;margin-bottom:4px}
.card .desc{color:#7f8fa6;font-size:0.85em;margin-bottom:16px}

/* Charts */
.chart-container{position:relative;width:100%}
.chart-tall{height:400px}
.chart-med{height:340px}

/* Insight box */
.insight-box{background:#0d1321;border-left:3px solid #00d2ff;padding:14px 18px;margin:16px 0 0;border-radius:0 8px 8px 0;font-size:0.92em}
.insight-box strong{color:#00d2ff}

/* Summary table */
.summary-table{width:100%;border-collapse:collapse;font-size:0.88em;margin:16px 0}
.summary-table th{background:#1e2a42;color:#00d2ff;padding:10px 14px;text-align:right;font-weight:600}
.summary-table td{padding:9px 14px;border-bottom:1px solid #1e2a42;text-align:right}
.summary-table th:first-child,.summary-table td:first-child{text-align:left}
.summary-table tr:hover td{background:#1a2235}
.summary-table .regime-dot{display:inline-block;width:10px;height:10px;border-radius:3px;margin-right:8px;vertical-align:middle}

/* Timer schedules */
.schedules{margin:0 0 8px}
.schedule-row{display:flex;align-items:center;margin-bottom:8px;gap:14px}
.schedule-label{width:150px;flex-shrink:0;font-size:0.82em;line-height:1.4}
.schedule-label .regime-hrs{color:#7f8fa6;font-size:0.9em}
.schedule-bar{flex:1;height:26px;border-radius:5px}
.schedule-axis{display:flex;margin-left:164px;margin-top:2px}
.schedule-axis span{flex:1;font-size:0.7em;color:#4a5568}

/* Methodology steps */
.steps{display:grid;grid-template-columns:repeat(3,1fr);gap:20px;margin:24px 0}
.step{background:#0d1321;border-radius:12px;padding:24px 20px;border:1px solid #1e2a42;position:relative}
.step-num{display:inline-flex;align-items:center;justify-content:center;width:32px;height:32px;border-radius:50%;background:#00d2ff;color:#0a0e17;font-weight:800;font-size:0.95em;margin-bottom:12px}
.step h4{color:#fff;font-size:0.95em;margin-bottom:8px}
.step p{color:#a4b0be;font-size:0.85em;line-height:1.6}

/* Cost summary */
.cost-summary{display:grid;grid-template-columns:repeat(3,1fr);gap:16px;margin:20px 0}
.cost-item{background:#0d1321;border-radius:10px;padding:18px;text-align:center;border:1px solid #1e2a42}
.cost-item .amount{font-size:1.8em;font-weight:700;color:#fff;line-height:1}
.cost-item .pct{font-size:0.85em;color:#7f8fa6;margin-top:2px}
.cost-item .cost-label{font-size:0.82em;color:#7f8fa6;margin-top:6px}

/* Conclusion */
.conclusion{background:linear-gradient(135deg,#0d1321,#141b2d);border:1px solid #00d2ff30;border-radius:12px;padding:28px;margin-top:24px;font-size:0.95em;line-height:1.7}
.conclusion strong{color:#00d2ff}

/* Footer */
.footer{text-align:center;color:#4a5568;font-size:0.8em;margin-top:48px;padding-top:24px;border-top:1px solid #1e2a42}
.footer a{color:#7f8fa6}

/* Responsive */
@media(max-width:900px){
  .stats{grid-template-columns:repeat(2,1fr)}
  .steps{grid-template-columns:1fr}
  .cost-summary{grid-template-columns:1fr}
  .hero h1{font-size:1.8em}
  .stat .num{font-size:2em}
  .schedule-label{width:120px}
  .schedule-axis{margin-left:134px}
  .schedule-bar{height:22px}
}
@media(max-width:500px){
  .stats{grid-template-columns:1fr}
  section h2{font-size:1.3em}
}
</style>
</head>
<body>
<div class="container">

<!-- ===== 1. HERO ===== -->
<div class="hero">
  <h1>Why Is My Heater Using 2&times; The Energy?</h1>
  <p class="lead">Analysing 16,896 half-hourly smart meter readings (352 days) across 3 timer regimes on the Octopus Agile tariff.</p>
  <div class="stats">
    <div class="stat"><div class="num" id="heroHeaterShare">--</div><div class="label">heater share of regime gap</div></div>
    <div class="stat"><div class="num" id="heroOnHours">--</div><div class="label">element run-time per day (Current winter vs Cozy)</div></div>
    <div class="stat"><div class="num" id="heroSaving">--</div><div class="label">saveable per year (best schedule)</div></div>
    <div class="stat"><div class="num" id="heroHeater">--</div><div class="label">heater kWh/day (Current winter vs Cozy)</div></div>
  </div>
</div>

<!-- ===== 2. THE WHOLE YEAR AT A GLANCE ===== -->
<section>
  <h2>The Whole Year at a Glance</h2>
  <p class="section-lead">Daily energy consumption, decomposed into heater (cyan) and household (grey). The 7-day rolling average (white line) reveals three distinct phases.</p>
  <div class="card">
    <div class="chart-container chart-tall"><canvas id="chartTimeline"></canvas></div>
    <div class="insight-box">
      <strong>August 26:</strong> the 7-day average jumps immediately and then rises sharply over the following week when the timer switches to the Current regime (on 20 h/day). Daily totals stay elevated through winter.
    </div>
  </div>
</section>

<!-- ===== 3. THE TIMER REGIMES ===== -->
<section>
  <h2>The Timer Regimes</h2>
  <p class="section-lead">In April 2025 the heater switched to the &ldquo;Cozy&rdquo; 3-window timer &mdash; enabled ~8&nbsp;h/day across three dip windows. In late August it changed to a near-continuous schedule: on ~20&nbsp;h/day, off only 16:00&ndash;20:00. These two regimes are the core comparison.</p>
  <div class="card">
    <h3>Timer Schedules</h3>
    <p class="desc">Coloured = element enabled. Dark = element disabled by timer.</p>
    <div class="schedules">
      <div class="schedule-row">
        <div class="schedule-label"><span class="regime-dot" style="background:#ffa502"></span>Cozy 3-window<br><span class="regime-hrs">~8 h enabled</span></div>
        <div class="schedule-bar" style="background:linear-gradient(to right,#1e2a42 0%,#1e2a42 16.67%,#ffa502 16.67%,#ffa502 29.17%,#1e2a42 29.17%,#1e2a42 54.17%,#ffa502 54.17%,#ffa502 66.67%,#1e2a42 66.67%,#1e2a42 91.67%,#ffa502 91.67%,#ffa502 100%)"></div>
      </div>
      <div class="schedule-row">
        <div class="schedule-label"><span class="regime-dot" style="background:#00d2ff"></span>Current<br><span class="regime-hrs">~20 h enabled</span></div>
        <div class="schedule-bar" style="background:linear-gradient(to right,#00d2ff 0%,#00d2ff 66.67%,#1e2a42 66.67%,#1e2a42 83.33%,#00d2ff 83.33%,#00d2ff 100%)"></div>
      </div>
      <div class="schedule-axis">
        <span>00</span><span>03</span><span>06</span><span>09</span><span>12</span><span>15</span><span>18</span><span>21</span>
      </div>
    </div>
  </div>
  <div class="card">
    <h3>Half-Hourly Consumption Profile</h3>
    <p class="desc">Average kWh per half-hour slot across the day (UK local time).</p>
    <div class="chart-container chart-tall"><canvas id="chartProfiles"></canvas></div>
  </div>
  <div class="card">
    <div style="overflow-x:auto">
      <table class="summary-table">
        <thead>
          <tr><th>Regime</th><th>Timer hours</th><th>Heater kWh/day</th><th>On-time h/day</th><th>Household kWh/day</th><th>Total kWh/day</th></tr>
        </thead>
        <tbody>
          <tr>
            <td><span class="regime-dot" style="background:#ffa502"></span>Cozy 3-window (May&ndash;Jun)</td>
            <td>~8 h/day</td><td id="tblCozyHeater">--</td><td id="tblCozyOn">--</td><td id="tblCozyOther">--</td><td id="tblCozyTotal">--</td>
          </tr>
          <tr>
            <td><span class="regime-dot" style="background:#7f8fa6"></span>Summer (Jul&ndash;Aug)</td>
            <td>~8 h/day</td><td id="tblSummerHeater">--</td><td id="tblSummerOn">--</td><td id="tblSummerOther">--</td><td id="tblSummerTotal">--</td>
          </tr>
          <tr>
            <td><span class="regime-dot" style="background:#00d2ff"></span>Current winter (Dec&ndash;Feb)</td>
            <td>~20 h/day</td><td id="tblWinterHeater">--</td><td id="tblWinterOn">--</td><td id="tblWinterOther">--</td><td id="tblWinterTotal">--</td>
          </tr>
        </tbody>
      </table>
    </div>
    <div class="insight-box">
      <strong id="regimeInsightHeadline">Short windows reduce heater runtime materially.</strong> The Current regime&rsquo;s 20-hour window substantially increases both enabled and actual run-time compared with Cozy.
    </div>
  </div>
</section>

<!-- ===== 4. THE PHYSICS: STANDBY HEAT LOSS ===== -->
<section>
  <h2>The Physics: Standby Heat Loss</h2>
  <p class="section-lead">Why does 20&nbsp;h of enabled time use nearly double the energy of 8&nbsp;h? The answer is standby heat loss &mdash; and we can measure it.</p>
  <div class="card">
    <h3>Distribution of Half-Hourly Readings</h3>
    <p class="desc">Smoothed density of readings (0.1 kWh bins). One representative month per regime.</p>
    <div class="chart-container chart-tall"><canvas id="chartDist"></canvas></div>
    <div class="insight-box">
      <strong>The pattern:</strong> under Cozy, most half-hour slots read zero &mdash; the thermostat is satisfied and the element stays off. Under Current, almost no slot is idle: the element fires in nearly every one. But it&rsquo;s not heating more water &mdash; so where is all that extra energy going?
    </div>
  </div>
  <div class="card">
    <h3>Heater Energy by Time of Day (Current Winter)</h3>
    <p class="desc">Average heater excess per half-hour slot, Dec 2025 &ndash; Feb 2026. Dashed line = standby floor. Red bars = measurement window.</p>
    <div class="chart-container chart-med"><canvas id="chartStandby"></canvas></div>
    <div class="insight-box">
      <strong>Standby heat loss.</strong> After the evening shower peak, energy decays exponentially overnight as the tank cools &mdash; bottoming at <strong id="standbyDirect">~233</strong>&nbsp;W between 05:00 and 06:00. That floor is pure heat leaking through the insulation, replenished by the element firing ~2&nbsp;min every half-hour.
    </div>
  </div>
  <div class="card">
    <h3>Measuring Standby Loss</h3>
    <p class="desc">Two independent methods converge on ~200W of continuous heat loss through the tank insulation.</p>
    <div class="steps" style="grid-template-columns:repeat(2,1fr)">
      <div class="step">
        <div class="step-num">1</div>
        <h4>Overnight minimum</h4>
        <p>Between 05:00 and 06:00 the tank has been cooling for 8+ hours. The element still fires ~2&nbsp;min per half-hour at 3.11&nbsp;kW, maintaining the thermostat setpoint. Measured: <strong>~233</strong>&nbsp;W.</p>
      </div>
      <div class="step">
        <div class="step-num">2</div>
        <h4>Regime comparison</h4>
        <p>Night regime (5&nbsp;h enabled) used 9.6&nbsp;kWh/day. Cozy (8&nbsp;h enabled) is ~10.2&nbsp;kWh/day in the linear model. The extra 0.6&nbsp;kWh over 3&nbsp;extra hours = <strong>~200W</strong> of standby loss.</p>
      </div>
    </div>
    <div class="card" style="margin:16px 0 0;background:#0d1321">
      <h3 style="font-size:0.95em;margin-bottom:12px">The Energy Model</h3>
      <p class="desc" style="margin-bottom:12px">This simple linear model is a first-order approximation of heater energy from timer hours.</p>
      <div style="text-align:center;font-size:1.3em;color:#fff;font-family:monospace;padding:8px 0 12px">
        heater<sub>kWh</sub> &nbsp;=&nbsp; 8.6 &nbsp;+&nbsp; 0.2 &times; enabled_hours
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;font-size:0.85em;color:#a4b0be">
        <div><strong style="color:#ffa502">8.6&nbsp;kWh</strong> = fixed draw energy (showers, taps). Doesn&rsquo;t change with the timer.</div>
        <div><strong style="color:#ff6b6b">0.2&nbsp;kW</strong> = standby heat loss. Every enabled hour costs an extra 0.2&nbsp;kWh (element fires ~4&nbsp;min/h to replace lost heat).</div>
      </div>
      <div style="overflow-x:auto;margin-top:16px">
        <table class="summary-table">
          <thead>
            <tr><th>Regime</th><th>Enabled hours</th><th>Model predicts</th><th>Actual</th><th>Match?</th></tr>
          </thead>
          <tbody>
            <tr><td><span class="regime-dot" style="background:#ff6b6b"></span>Night</td><td>5&nbsp;h</td><td>9.6 kWh</td><td>9.6 kWh</td><td style="color:#2ed573">exact</td></tr>
            <tr><td><span class="regime-dot" style="background:#ffa502"></span>Cozy</td><td>8&nbsp;h</td><td>10.2 kWh</td><td>~10&ndash;12 kWh</td><td style="color:#ffd32a">approx</td></tr>
            <tr><td><span class="regime-dot" style="background:#00d2ff"></span>Current</td><td>20&nbsp;h</td><td>12.6 kWh</td><td>~19.3 kWh (winter)</td><td style="color:#ff6b6b">underpredicts</td></tr>
          </tbody>
        </table>
      </div>
      <div class="insight-box" style="margin-top:12px">
        <strong>Why does the model break for Current?</strong> With 20&nbsp;h enabled, the tank spends much more time near thermostat setpoint. That raises effective standby loss versus short-window regimes, so this linear model should be treated as directional, not exact.
      </div>
    </div>
  </div>
</section>

<!-- ===== 5. THE BILL ===== -->
<section>
  <h2>The Bill</h2>
  <p class="section-lead">Monthly electricity cost on the Octopus Agile tariff, decomposed using the same methodology.</p>
  <div class="card">
    <h3>Monthly Cost Breakdown</h3>
    <p class="desc">Stacked bars show heater (cyan) and household (grey) costs. Line shows heater share of total.</p>
    <div class="chart-container chart-med"><canvas id="chartCost"></canvas></div>
  </div>
  <div class="cost-summary">
    <div class="cost-item">
      <div class="amount" style="color:#00d2ff" id="costHeaterAnnual">--</div>
      <div class="pct" id="costHeaterPct">--</div>
      <div class="cost-label">Heater (annual)</div>
    </div>
    <div class="cost-item">
      <div class="amount" style="color:#7f8fa6" id="costHouseAnnual">--</div>
      <div class="pct" id="costHousePct">--</div>
      <div class="cost-label">Household (annual)</div>
    </div>
    <div class="cost-item">
      <div class="amount" id="costTotalAnnual">--</div>
      <div class="pct">&nbsp;</div>
      <div class="cost-label">Total (annual)</div>
    </div>
  </div>
</section>

<!-- ===== 6. THE OPTIMAL TIMER ===== -->
<section>
  <h2>The Optimal Timer</h2>
  <p class="section-lead">The heater costs <span id="currentHeaterAnnual">&pound;--</span>/year in this model &mdash; much of it standby waste. Can we do better than just reverting to Cozy?</p>
  <div class="card">
    <h3>How to Find the Best Schedule</h3>
    <p class="desc">The optimisation has two levers. Pulling both at once gives the biggest saving.</p>
    <div class="steps" style="grid-template-columns:repeat(2,1fr)">
      <div class="step">
        <div class="step-num">1</div>
        <h4>Minimize timer hours</h4>
        <p>From the energy model: every enabled hour adds ~0.2&nbsp;kWh of standby loss. Reducing from 20&nbsp;h to 5&nbsp;h eliminates ~3&nbsp;kWh/day of pure waste.</p>
      </div>
      <div class="step">
        <div class="step-num">2</div>
        <h4>Choose the cheapest hours</h4>
        <p>Agile tariff rates vary strongly across the day. Shifting the window to cheap slots cuts £/kWh from ~<span id="rateCurrent">--</span> to ~<span id="rateBest">--</span> &mdash; about <span id="rateCutPct">--</span> rate saving on top.</p>
      </div>
    </div>
    <div class="card" style="margin:16px 0 0;background:#0d1321">
      <h3 style="font-size:0.95em;margin-bottom:8px">The Cost Formula</h3>
      <div style="text-align:center;font-size:1.2em;color:#fff;font-family:monospace;padding:8px 0 12px">
        annual_cost &nbsp;=&nbsp; (8.6 + 0.2 &times; hours) &times; 365 &times; avg_rate
      </div>
      <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;font-size:0.85em;color:#a4b0be;text-align:center">
        <div><strong style="color:#ffa502">energy model</strong><br>kWh per day</div>
        <div><strong style="color:#7f8fa6">days per year</strong></div>
        <div><strong style="color:#2ed573">Agile rate</strong><br>p/kWh during window</div>
      </div>
    </div>
  </div>
  <div class="card">
    <h3>Agile Rate Profile</h3>
    <p class="desc">Median half-hourly Agile rate across the full dataset. Green = cheap (&lt;17p), orange = moderate, red = peak (&gt;25p). Dashed line = overall median.</p>
    <div class="chart-container chart-med"><canvas id="chartAgileRate"></canvas></div>
  </div>
  <div class="card">
    <h3>Timer Schedules Compared</h3>
    <p class="desc">Coloured = element enabled. Dark = element disabled.</p>
    <div class="schedules" id="optimalSchedules"></div>
    <div style="overflow-x:auto;margin-top:16px">
      <table class="summary-table" id="optimalTable">
        <thead>
          <tr><th>Schedule</th><th>Windows</th><th>Enabled</th><th>Avg rate</th><th>Heater kWh/day</th><th>Heater £/year</th><th>Saving</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
  <div class="conclusion">
    <strong>Recommendation:</strong> The <strong>Optimal</strong> 2-window schedule (13&ndash;16, 22&ndash;00) saves roughly <strong id="optSavingOpt">&pound;--</strong>/year vs the current timer in this model-based comparison. It keeps hot water available for midnight showers while targeting cheaper Agile slots outside peak hours. Even reverting to <strong>Cozy</strong> saves <strong id="optSavingCozy">&pound;--</strong>/year. Any short schedule is dramatically better than 20&nbsp;h/day.
  </div>
</section>

<!-- ===== 7. HOW WE KNOW ===== -->
<section>
  <h2>How We Know: Separating Heater from Household</h2>
  <p class="section-lead">A single smart meter measures everything. Here&rsquo;s how we split heater energy from household baseload.</p>
  <div class="steps">
    <div class="step">
      <div class="step-num">1</div>
      <h4>The problem</h4>
      <p>One meter measures the 3.11&nbsp;kW immersion heater and all household appliances together. We need to decompose every half-hour reading into heater vs household.</p>
    </div>
    <div class="step">
      <div class="step-num">2</div>
      <h4>The trick</h4>
      <p>Each timer regime has hours when the heater is guaranteed OFF. We measure household-only consumption during these &ldquo;clean windows&rdquo; to build a time-of-day baseline (130&nbsp;W overnight to 450&nbsp;W at the evening peak).</p>
    </div>
    <div class="step">
      <div class="step-num">3</div>
      <h4>The result</h4>
      <p>Subtract the hourly baseline from each reading and cap at 1.555&nbsp;kWh (element max per slot). The household baseline stays flat at ~5.5&ndash;7&nbsp;kWh/day across all regimes, confirming the split works.</p>
    </div>
  </div>
  <div class="card">
    <h3>Illustrated: Cozy Regime</h3>
    <p class="desc">The three timer windows (04&ndash;07, 13&ndash;16, 22&ndash;00) leave two clean gaps (green bands) where readings are guaranteed household-only &mdash; giving us the baseline to subtract everywhere else.</p>
    <div class="chart-container chart-med"><canvas id="chartMethod"></canvas></div>
  </div>
  <div class="card">
    <h3>Monthly Decomposition</h3>
    <p class="desc">Household load (grey) is stable year-round. The entire swing comes from the heater (cyan).</p>
    <div class="chart-container chart-med"><canvas id="chartMonthly"></canvas></div>
  </div>
  <div class="insight-box" style="margin-top:-12px">
    <strong>Why not simpler methods?</strong> A flat threshold (&gt;0.8&nbsp;kWh = heater) over-attributes household baseline to the heater, yielding a false element power of 2.83&nbsp;kW instead of the measured 3.11&nbsp;kW. A fixed baseline catches cooking/kettle spikes as &ldquo;heater&rdquo; energy. Only regime-specific clean windows give a stable, validated split.
  </div>
</section>

<div class="footer">
  Analysis of Octopus Energy smart meter data &middot; Mar 2025 &ndash; Feb 2026 &middot; <a href="https://github.com/cheparukhin/octopus">Source</a>
</div>

</div><!-- container -->

<script>
fetch('report_data.json')
  .then(r => r.json())
  .then(D => {

const CYAN = '#00d2ff';
const CYAN50 = 'rgba(0,210,255,0.5)';
const GREY = '#7f8fa6';
const GREY50 = 'rgba(127,143,166,0.5)';
const ORANGE = '#ffa502';
const YELLOW = '#ffd32a';
const WHITE = '#ffffff';
const GRID = 'rgba(255,255,255,0.06)';
const FONT = '#a4b0be';
Chart.defaults.color = FONT;
Chart.defaults.borderColor = GRID;
Chart.defaults.font.family = "'Segoe UI', system-ui, sans-serif";

function avgDaily(start, end) {
  const rows = D.daily.filter(r => r.date >= start && r.date <= end);
  if (!rows.length) return null;
  const heater = rows.reduce((a, r) => a + r.heater, 0) / rows.length;
  const other = rows.reduce((a, r) => a + r.other, 0) / rows.length;
  const total = heater + other;
  return { heater, other, total, onHours: heater / 3.11, n: rows.length };
}

function gbp(v) {
  return '£' + Math.round(v).toLocaleString('en-GB');
}

function one(v) {
  return (Math.round(v * 10) / 10).toFixed(1);
}

// ===== Headline + regime summary =====
const cozyStats = avgDaily('2025-05-01', '2025-06-30');
const summerStats = avgDaily('2025-07-01', '2025-08-25');
const winterStats = avgDaily('2025-12-01', '2026-02-16');

if (cozyStats && winterStats) {
  const gapTotal = winterStats.total - cozyStats.total;
  const gapHeater = winterStats.heater - cozyStats.heater;
  const heaterShare = gapTotal > 0 ? Math.round((gapHeater / gapTotal) * 100) : 0;
  document.getElementById('heroHeaterShare').textContent = heaterShare + '%';
  document.getElementById('heroOnHours').textContent = one(winterStats.onHours) + ' h';
  document.getElementById('heroHeater').textContent =
    one(winterStats.heater) + ' (vs ' + one(cozyStats.heater) + ')';
  document.getElementById('tblCozyHeater').textContent = one(cozyStats.heater);
  document.getElementById('tblCozyOn').textContent = one(cozyStats.onHours);
  document.getElementById('tblCozyOther').textContent = one(cozyStats.other);
  document.getElementById('tblCozyTotal').textContent = one(cozyStats.total);
  document.getElementById('tblWinterHeater').textContent = one(winterStats.heater);
  document.getElementById('tblWinterOn').textContent = one(winterStats.onHours);
  document.getElementById('tblWinterOther').textContent = one(winterStats.other);
  document.getElementById('tblWinterTotal').textContent = one(winterStats.total);
}
if (summerStats) {
  document.getElementById('tblSummerHeater').textContent = one(summerStats.heater);
  document.getElementById('tblSummerOn').textContent = one(summerStats.onHours);
  document.getElementById('tblSummerOther').textContent = one(summerStats.other);
  document.getElementById('tblSummerTotal').textContent = one(summerStats.total);
}

// ===== Annualized cost cards =====
const heaterPeriod = D.cost.monthly.reduce((a, m) => a + m.heater_gbp, 0);
const housePeriod = D.cost.monthly.reduce((a, m) => a + m.household_gbp, 0);
const analyzedDays = D.daily.length || 365;
const annualScale = 365 / analyzedDays;
const heaterAnnual = heaterPeriod * annualScale;
const houseAnnual = housePeriod * annualScale;
const totalAnnual = heaterAnnual + houseAnnual;
const heaterPct = totalAnnual > 0 ? (heaterAnnual / totalAnnual * 100) : 0;
const housePct = totalAnnual > 0 ? (houseAnnual / totalAnnual * 100) : 0;

document.getElementById('costHeaterAnnual').textContent = gbp(heaterAnnual);
document.getElementById('costHouseAnnual').textContent = gbp(houseAnnual);
document.getElementById('costTotalAnnual').textContent = gbp(totalAnnual);
document.getElementById('costHeaterPct').textContent = heaterPct.toFixed(0) + '% of total';
document.getElementById('costHousePct').textContent = housePct.toFixed(0) + '% of total';

// ===== DAILY TIMELINE with regime background bands =====
const dates = D.daily.map(d => d.date);
const nightEnd = dates.indexOf('2025-04-10');
const cozyEnd = dates.indexOf('2025-08-26');
const regimeBandsPlugin = {
  id: 'regimeBands',
  beforeDraw(chart) {
    const {ctx, chartArea: {left, right, top, bottom}, scales: {x}} = chart;
    const bands = [
      [0, nightEnd >= 0 ? nightEnd : 0, 'rgba(255,107,107,0.07)'],
      [nightEnd >= 0 ? nightEnd : 0, cozyEnd >= 0 ? cozyEnd : 0, 'rgba(255,165,2,0.07)'],
      [cozyEnd >= 0 ? cozyEnd : 0, dates.length - 1, 'rgba(0,210,255,0.07)'],
    ];
    bands.forEach(([start, end, color]) => {
      const x1 = Math.max(x.getPixelForValue(start), left);
      const x2 = Math.min(x.getPixelForValue(end), right);
      ctx.save();
      ctx.fillStyle = color;
      ctx.fillRect(x1, top, x2 - x1, bottom - top);
      ctx.restore();
    });
    // Transition labels
    [[nightEnd, 'Night\u2192Cozy', ORANGE], [cozyEnd, 'Cozy\u2192Current', CYAN]].forEach(([idx, label, color]) => {
      if (idx < 0) return;
      const xp = x.getPixelForValue(idx);
      ctx.save();
      ctx.strokeStyle = color;
      ctx.lineWidth = 1.5;
      ctx.setLineDash([4, 4]);
      ctx.beginPath();
      ctx.moveTo(xp, top);
      ctx.lineTo(xp, bottom);
      ctx.stroke();
      ctx.fillStyle = color;
      ctx.font = '11px sans-serif';
      ctx.textAlign = 'center';
      ctx.fillText(label, xp, top - 5);
      ctx.restore();
    });
  }
};
new Chart(document.getElementById('chartTimeline'), {
  type: 'bar',
  data: {
    labels: dates,
    datasets: [
      { label: 'Heater', data: D.daily.map(d => d.heater),
        backgroundColor: CYAN50, borderWidth: 0, barPercentage: 1.0, categoryPercentage: 1.0 },
      { label: 'Household', data: D.daily.map(d => d.other),
        backgroundColor: GREY50, borderWidth: 0, barPercentage: 1.0, categoryPercentage: 1.0 },
      { label: '7-day avg', data: D.daily.map(d => d.rolling7),
        type: 'line', borderColor: WHITE, backgroundColor: 'transparent',
        pointRadius: 0, borderWidth: 1.5, tension: 0.3, spanGaps: true }
    ]
  },
  options: {
    responsive: true, maintainAspectRatio: false,
    scales: {
      x: { stacked: true, ticks: { maxTicksLimit: 13, callback: function(v, i) {
        const d = D.daily[i]?.date; return d ? d.substring(0, 7) : '';
      } } },
      y: { stacked: true, title: { display: true, text: 'kWh / day' } }
    },
    plugins: { legend: { position: 'top' } }
  },
  plugins: [regimeBandsPlugin]
});

// ===== HALF-HOURLY PROFILES =====
new Chart(document.getElementById('chartProfiles'), {
  type: 'line',
  data: {
    labels: D.profiles.cozy.map(p => p.slot),
    datasets: [
      { label: 'Cozy 3-window (May\u2013Jun 2025)', data: D.profiles.cozy.map(p => p.mean),
        borderColor: ORANGE, backgroundColor: 'transparent', tension: 0.3, borderWidth: 2, pointRadius: 0 },
      { label: 'Summer (Jul\u2013Aug 2025)', data: D.profiles.summer.map(p => p.mean),
        borderColor: GREY, backgroundColor: 'transparent', borderDash: [5, 5], tension: 0.3, borderWidth: 1.5, pointRadius: 0 },
      { label: 'Current winter (Dec 2025\u2013Feb 2026)', data: D.profiles.current_winter.map(p => p.mean),
        borderColor: CYAN, backgroundColor: CYAN50, fill: true, tension: 0.3, borderWidth: 2, pointRadius: 0 },
    ]
  },
  options: {
    responsive: true, maintainAspectRatio: false,
    scales: {
      x: { title: { display: true, text: 'Time of day (UK local)' },
           ticks: { maxTicksLimit: 24, callback: function(v, i) { return i % 2 === 0 ? this.getLabelForValue(v) : ''; } } },
      y: { title: { display: true, text: 'Avg kWh per half-hour' }, beginAtZero: true }
    },
    interaction: { intersect: false, mode: 'index' },
    plugins: { legend: { position: 'top' } }
  }
});

// ===== MONTHLY DECOMPOSITION =====
new Chart(document.getElementById('chartMonthly'), {
  type: 'bar',
  data: {
    labels: D.monthly.map(m => m.month),
    datasets: [
      { label: 'Heater (3.11 kW element)', data: D.monthly.map(m => m.heater),
        backgroundColor: CYAN50, borderColor: CYAN, borderWidth: 1 },
      { label: 'Household (baseline)', data: D.monthly.map(m => m.other),
        backgroundColor: GREY50, borderColor: GREY, borderWidth: 1 },
    ]
  },
  options: {
    responsive: true, maintainAspectRatio: false,
    scales: {
      x: { stacked: true },
      y: { stacked: true, title: { display: true, text: 'Avg kWh / day' } }
    },
    plugins: { legend: { position: 'top' } }
  }
});

// ===== DISTRIBUTION (smooth area curves) =====
const distStyle = {
  'May 2025 (cozy)':    { bg: 'rgba(255,165,2,0.15)',   border: ORANGE },
  'Jan 2026 (current)': { bg: 'rgba(0,210,255,0.15)',   border: CYAN   },
};
const distKeys = ['Jan 2026 (current)', 'May 2025 (cozy)'];
new Chart(document.getElementById('chartDist'), {
  type: 'line',
  data: {
    labels: D.dist_labels,
    datasets: distKeys.map(k => ({
      label: k, data: D.distributions[k],
      backgroundColor: distStyle[k].bg,
      borderColor: distStyle[k].border, borderWidth: 2,
      fill: true, tension: 0.4, pointRadius: 0
    }))
  },
  options: {
    responsive: true, maintainAspectRatio: false,
    scales: {
      x: { title: { display: true, text: 'kWh per half-hour slot' },
           ticks: { maxTicksLimit: 18, callback: function(v, i) { return i % 3 === 0 ? this.getLabelForValue(v) : ''; } } },
      y: { title: { display: true, text: 'Number of readings' } }
    },
    interaction: { intersect: false, mode: 'index' },
    plugins: { legend: { position: 'top' } }
  }
});

// ===== MONTHLY COST =====
new Chart(document.getElementById('chartCost'), {
  type: 'bar',
  data: {
    labels: D.cost.monthly.map(m => m.month),
    datasets: [
      { label: 'Heater cost (\u00a3)', data: D.cost.monthly.map(m => m.heater_gbp),
        backgroundColor: CYAN50, borderColor: CYAN, borderWidth: 1 },
      { label: 'Household cost (\u00a3)', data: D.cost.monthly.map(m => m.household_gbp),
        backgroundColor: GREY50, borderColor: GREY, borderWidth: 1 },
      { label: 'Heater % of total', data: D.cost.monthly.map(m => m.heater_pct),
        type: 'line', borderColor: YELLOW, backgroundColor: 'transparent',
        pointRadius: 4, pointBackgroundColor: YELLOW, yAxisID: 'y1', borderWidth: 2 },
    ]
  },
  options: {
    responsive: true, maintainAspectRatio: false,
    scales: {
      x: { stacked: true },
      y: { stacked: true, title: { display: true, text: '\u00a3 / month' } },
      y1: { position: 'right', title: { display: true, text: 'Heater %' }, min: 0, max: 80, grid: { display: false } }
    },
    plugins: { legend: { position: 'top' } }
  }
});

// ===== METHODOLOGY ILLUSTRATION (Cozy regime) =====
const methodBandsPlugin = {
  id: 'methodBands',
  beforeDraw(chart) {
    const {ctx, chartArea: {left, right, top, bottom}, scales: {x}} = chart;
    // Cozy clean windows: 07:00-13:00 (indices 14-25) and 16:00-22:00 (indices 32-43)
    const windows = [[14, 25, '07:00\u201313:00'], [32, 43, '16:00\u201322:00']];
    windows.forEach(([start, end, label]) => {
      const x1 = x.getPixelForValue(start);
      const x2 = x.getPixelForValue(end);
      ctx.save();
      ctx.fillStyle = 'rgba(46,213,115,0.08)';
      ctx.fillRect(x1, top, x2 - x1, bottom - top);
      ctx.fillStyle = 'rgba(46,213,115,0.55)';
      ctx.font = '11px sans-serif';
      ctx.textAlign = 'center';
      ctx.fillText('Timer OFF \u2192 baseline', (x1 + x2) / 2, top + 15);
      // Dashed borders
      [x1, x2].forEach(xp => {
        ctx.strokeStyle = 'rgba(46,213,115,0.35)';
        ctx.lineWidth = 1;
        ctx.setLineDash([4, 4]);
        ctx.beginPath();
        ctx.moveTo(xp, top);
        ctx.lineTo(xp, bottom);
        ctx.stroke();
      });
      ctx.restore();
    });
  }
};
new Chart(document.getElementById('chartMethod'), {
  type: 'line',
  data: {
    labels: D.profiles.cozy.map(p => p.slot),
    datasets: [{
      label: 'Cozy avg consumption',
      data: D.profiles.cozy.map(p => p.mean),
      borderColor: ORANGE,
      backgroundColor: 'rgba(255,165,2,0.15)',
      fill: true,
      tension: 0.3,
      pointRadius: 0,
      borderWidth: 2,
    }]
  },
  options: {
    responsive: true, maintainAspectRatio: false,
    scales: {
      x: { title: { display: true, text: 'Time of day (UK local)' },
           ticks: { maxTicksLimit: 24, callback: function(v, i) { return i % 4 === 0 ? this.getLabelForValue(v) : ''; } } },
      y: { title: { display: true, text: 'Avg kWh per half-hour' }, beginAtZero: true }
    },
    plugins: { legend: { display: false } }
  },
  plugins: [methodBandsPlugin]
});

// ===== STANDBY HEAT LOSS PROFILE =====
const standbyProfile = D.standby.profile;
const standbyWatts = D.standby.standby_watts;
document.getElementById('standbyDirect').textContent = '~' + standbyWatts;
const standbyLinePlugin = {
  id: 'standbyLine',
  afterDraw(chart) {
    const {ctx, chartArea: {left, right, top, bottom}, scales: {y}} = chart;
    const yVal = y.getPixelForValue(standbyWatts / 2000);
    ctx.save();
    ctx.strokeStyle = '#ff6b6b';
    ctx.lineWidth = 1.5;
    ctx.setLineDash([6, 4]);
    ctx.beginPath();
    ctx.moveTo(left, yVal);
    ctx.lineTo(right, yVal);
    ctx.stroke();
    ctx.fillStyle = '#ff6b6b';
    ctx.font = '11px sans-serif';
    ctx.textAlign = 'right';
    ctx.fillText(standbyWatts + 'W standby floor', right - 4, yVal - 6);
    ctx.restore();
  }
};
new Chart(document.getElementById('chartStandby'), {
  type: 'bar',
  data: {
    labels: standbyProfile.map(p => p.slot),
    datasets: [{
      label: 'Heater excess (kWh)',
      data: standbyProfile.map(p => p.heater_kwh),
      backgroundColor: standbyProfile.map(p => {
        if (p.slot === '05:00' || p.slot === '05:30') return '#ff6b6b';
        if (p.slot >= '21:00' || p.slot < '04:00') return CYAN;
        return CYAN50;
      }),
      borderWidth: 0,
      barPercentage: 1.0,
      categoryPercentage: 1.0,
    }]
  },
  options: {
    responsive: true, maintainAspectRatio: false,
    scales: {
      x: { title: { display: true, text: 'Time of day (UK local)' },
           ticks: { maxTicksLimit: 24, callback: function(v, i) { return i % 4 === 0 ? this.getLabelForValue(v) : ''; } } },
      y: { title: { display: true, text: 'Avg heater kWh per half-hour' }, beginAtZero: true }
    },
    plugins: { legend: { display: false } }
  },
  plugins: [standbyLinePlugin]
});

// ===== AGILE RATE PROFILE =====
const rateProfile = D.optimal.rate_profile;
const medianRate = D.optimal.overall_median;
const medianLinePlugin = {
  id: 'medianLine',
  afterDraw(chart) {
    const {ctx, chartArea: {left, right, top, bottom}, scales: {y}} = chart;
    const yVal = y.getPixelForValue(medianRate);
    ctx.save();
    ctx.strokeStyle = WHITE;
    ctx.lineWidth = 1.5;
    ctx.setLineDash([6, 4]);
    ctx.beginPath();
    ctx.moveTo(left, yVal);
    ctx.lineTo(right, yVal);
    ctx.stroke();
    ctx.fillStyle = WHITE;
    ctx.font = '11px sans-serif';
    ctx.textAlign = 'left';
    ctx.fillText('Median ' + medianRate + 'p', left + 4, yVal - 6);
    ctx.restore();
  }
};
const GREEN = '#2ed573';
const RED = '#ff6b6b';
const optimalWindowPlugin = {
  id: 'optimalWindow',
  beforeDraw(chart) {
    const {ctx, chartArea: {left, right, top, bottom}, scales: {x}} = chart;
    const windows = [[26, 32], [44, 48]];
    ctx.save();
    windows.forEach(([a, b]) => {
      const x1 = x.getPixelForValue(a);
      const x2 = x.getPixelForValue(Math.min(b, 47));
      ctx.fillStyle = 'rgba(46,213,115,0.08)';
      ctx.fillRect(x1, top, x2 - x1, bottom - top);
      [x1, x2].forEach(xp => {
        ctx.strokeStyle = 'rgba(46,213,115,0.35)';
        ctx.lineWidth = 1;
        ctx.setLineDash([4, 4]);
        ctx.beginPath();
        ctx.moveTo(xp, top);
        ctx.lineTo(xp, bottom);
        ctx.stroke();
      });
    });
    ctx.fillStyle = 'rgba(46,213,115,0.55)';
    ctx.font = '11px sans-serif';
    ctx.textAlign = 'center';
    const midX = x.getPixelForValue(35);
    ctx.fillText('Optimal 2-window (5 h)', midX, top + 15);
    ctx.restore();
  }
};
new Chart(document.getElementById('chartAgileRate'), {
  type: 'bar',
  data: {
    labels: rateProfile.map(p => p.slot),
    datasets: [{
      label: 'Median Agile rate (p/kWh)',
      data: rateProfile.map(p => p.median_rate),
      backgroundColor: rateProfile.map(p => {
        if (p.median_rate > 25) return RED;
        if (p.median_rate > 17) return ORANGE;
        return GREEN;
      }),
      borderWidth: 0,
      barPercentage: 1.0,
      categoryPercentage: 1.0,
    }]
  },
  options: {
    responsive: true, maintainAspectRatio: false,
    scales: {
      x: { title: { display: true, text: 'Time of day (UK local)' },
           ticks: { maxTicksLimit: 24, callback: function(v, i) { return i % 4 === 0 ? this.getLabelForValue(v) : ''; } } },
      y: { title: { display: true, text: 'p / kWh' }, beginAtZero: true }
    },
    plugins: { legend: { display: false } }
  },
  plugins: [medianLinePlugin, optimalWindowPlugin]
});

// ===== OPTIMAL TIMER SCHEDULES (bars + table) =====
const optSchedules = D.optimal.schedules;
const schedContainer = document.getElementById('optimalSchedules');
optSchedules.forEach(sched => {
  const enabledSet = new Set(sched.enabled_slots);
  // Build gradient stops: each slot is 1/48 of the bar
  const stops = [];
  for (let i = 0; i < 48; i++) {
    const h = Math.floor(i / 2);
    const m = (i % 2) * 30;
    const slot = String(h).padStart(2, '0') + ':' + String(m).padStart(2, '0');
    const pct1 = (i / 48 * 100).toFixed(2);
    const pct2 = ((i + 1) / 48 * 100).toFixed(2);
    const color = enabledSet.has(slot) ? sched.color : '#1e2a42';
    stops.push(color + ' ' + pct1 + '%,' + color + ' ' + pct2 + '%');
  }
  const row = document.createElement('div');
  row.className = 'schedule-row';
  row.innerHTML = '<div class="schedule-label"><span class="regime-dot" style="background:' + sched.color + '"></span>' + sched.name + '<br><span class="regime-hrs">' + sched.enabled_hours + ' h enabled</span></div>' +
    '<div class="schedule-bar" style="background:linear-gradient(to right,' + stops.join(',') + ')"></div>';
  schedContainer.appendChild(row);
});
// Axis
const axisDiv = document.createElement('div');
axisDiv.className = 'schedule-axis';
axisDiv.innerHTML = '<span>00</span><span>03</span><span>06</span><span>09</span><span>12</span><span>15</span><span>18</span><span>21</span>';
schedContainer.appendChild(axisDiv);

// Table
const tbody = document.querySelector('#optimalTable tbody');
optSchedules.forEach(sched => {
  const tr = document.createElement('tr');
  const savingText = sched.saving > 0 ? ('\u00a3' + sched.saving + '/yr') : '\u2014';
  const savingStyle = sched.saving > 0 ? 'color:#2ed573;font-weight:600' : '';
  tr.innerHTML = '<td><span class="regime-dot" style="background:' + sched.color + '"></span>' + sched.name + '</td>' +
    '<td>' + sched.windows_desc + '</td>' +
    '<td>' + sched.enabled_hours + ' h</td>' +
    '<td>' + sched.avg_rate + 'p</td>' +
    '<td>' + sched.heater_kwh + '</td>' +
    '<td>\u00a3' + sched.annual_cost + '</td>' +
    '<td style="' + savingStyle + '">' + savingText + '</td>';
  tbody.appendChild(tr);
});

// Update dynamic conclusion and headline values
const currentSched = optSchedules.find(s => s.name === 'Current') || optSchedules[0];
const cozySched = optSchedules.find(s => s.name === 'Cozy') || optSchedules[1] || optSchedules[0];
const bestSched = optSchedules.reduce((best, s) => (s.annual_cost < best.annual_cost ? s : best), optSchedules[0]);
const savingOpt = bestSched?.saving ?? 0;
const savingCozy = cozySched?.saving ?? 0;
document.getElementById('optSavingOpt').textContent = '\u00a3' + Math.round(savingOpt);
document.getElementById('optSavingCozy').textContent = '\u00a3' + Math.round(savingCozy);
document.getElementById('heroSaving').textContent = gbp(savingOpt);
document.getElementById('currentHeaterAnnual').textContent = gbp(currentSched?.annual_cost || 0);

if (currentSched && bestSched) {
  const rateCut = currentSched.avg_rate > 0
    ? ((currentSched.avg_rate - bestSched.avg_rate) / currentSched.avg_rate * 100)
    : 0;
  document.getElementById('rateCurrent').textContent = currentSched.avg_rate.toFixed(2) + 'p';
  document.getElementById('rateBest').textContent = bestSched.avg_rate.toFixed(2) + 'p';
  document.getElementById('rateCutPct').textContent = rateCut.toFixed(0) + '%';
}

}).catch(() => {
  document.querySelector('.container').insertAdjacentHTML('afterbegin',
    '<p style="color:#ff6b6b;text-align:center;padding:40px">Failed to load report_data.json</p>');
});
</script>
</body>
</html>
